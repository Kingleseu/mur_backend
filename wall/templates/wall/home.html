{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mur de T√©moignages Bunda21 - CMP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Merriweather:wght@400;700&family=Indie+Flower&family=Caveat:wght@400;700&family=Patrick+Hand&family=Kalam:wght@400;700&family=Permanent+Marker&family=Shadows+Into+Light&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif;background:white;overflow-x:hidden}
    h1{font-size:3rem;line-height:1.2;font-weight:700}
    h2{font-size:2.5rem;line-height:1.2;font-weight:700}
    h3{font-size:1.5rem;line-height:1.3;font-weight:600}
    @media (max-width:768px){h1{font-size:2rem}h2{font-size:1.75rem}h3{font-size:1.25rem}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes scaleIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    @keyframes scroll{0%{transform:translateY(0)}100%{transform:translateY(-2400px)}}
    @keyframes pulse-soft{0%,100%{transform:scale(1);box-shadow:0 20px 40px rgba(149,0,0,.2)}50%{transform:scale(1.02);box-shadow:0 25px 50px rgba(149,0,0,.3)}}
    .animate-fadeIn{animation:fadeIn .6s ease-out forwards}
    .animate-fadeInUp{animation:fadeInUp .8s ease-out forwards}
    .animate-scaleIn{animation:scaleIn .5s ease-out forwards}
    .animate-bounce{animation:bounce 2s ease-in-out infinite}
    .animate-pulse-soft{animation:pulse-soft 2s ease-in-out infinite}
    .modal-backdrop{background:rgba(0,0,0,.7);backdrop-filter:blur(4px)}
    .carousel-column{animation:scroll 50s linear infinite}
    .carousel-column-2{animation:scroll 55s linear infinite;animation-delay:-5s}
    .postit-card{transition:all .3s cubic-bezier(.4,0,.2,1)}
    .postit-card:hover{transform:scale(1.05) rotate(0deg)!important;box-shadow:0 20px 40px rgba(0,0,0,.15);z-index:10}
    .font-inter{font-family:'Inter',sans-serif}
    .font-merriweather{font-family:'Merriweather',serif}
    .font-indie-flower{font-family:'Indie Flower',cursive}
    .font-caveat{font-family:'Caveat',cursive}
    .font-patrick-hand{font-family:'Patrick Hand',cursive}
    .font-kalam{font-family:'Kalam',cursive}
    .font-permanent-marker{font-family:'Permanent Marker',cursive}
    .font-shadows{font-family:'Shadows Into Light',cursive}
    .line-clamp-1{overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1}
    .line-clamp-2{overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2}
    .line-clamp-3{overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3}
    .toast{position:fixed;top:20px;right:20px;background:#fff;padding:16px 24px;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,.15);z-index:10000;animation:fadeIn .3s ease-out}
  </style>
</head>
<body>
  <!-- Inject DB testimonies as JSON -->
  <script>
    const testimonies = {{ testimonies_json|safe }};
  </script>

  <!-- Page content copied/adapted from provided index.html -->
  <div id="hero" class="relative min-h-screen flex items-center overflow-hidden" style="background:#000000;">
    <div class="absolute inset-0" style="background:radial-gradient(circle at 30% 50%, rgba(149,0,0,.15) 0%, rgba(0,0,0,0) 50%)"></div>
    <div id="authButton" class="absolute top-6 right-6 z-20"></div>
    <div class="relative z-10 w-full max-w-[1800px] mx-auto px-6 lg:px-12 py-20">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 items-center">
        <div class="space-y-6 lg:space-y-8 text-center lg:text-left">
          <div class="flex justify-center lg:justify-start animate-fadeIn">
            <div class="h-24 md:h-28 lg:h-32 flex items-center justify-center text-white">
              <div class="text-center">
                <div class="text-6xl font-bold text-[#FFD53D]" style="text-shadow:0 4px 30px rgba(255,213,61,.3)">BUNDA21</div>
                <div class="text-sm mt-2 text-gray-300">21 jours de je√ªne et pri√®res</div>
              </div>
            </div>
          </div>
          <div class="animate-fadeInUp" style="animation-delay:.2s;"><h1 class="text-white">Ce que Dieu a fait pour nous !</h1></div>
          <div class="animate-fadeInUp" style="animation-delay:.4s;"><h3 class="text-gray-300">Partag√©, conserv√©, c√©l√©br√©.</h3></div>
          <div class="max-w-[420px] mx-auto lg:mx-0 animate-fadeInUp" style="animation-delay:.6s;"><p class="text-gray-400 leading-relaxed">Un espace vivant o√π chaque fid√®le partage son action de gr√¢ce. D√©couvrez comment Dieu transforme des vies au quotidien.</p></div>
          <div class="pt-4 animate-fadeInUp" style="animation-delay:.8s;"><button onclick="openTestimonyForm()" class="bg-[#950000] hover:bg-[#750000] text-white px-8 py-3 rounded-[14px] shadow-lg hover:shadow-2xl transition-all">J'ai un t√©moignage</button></div>
          <div class="flex items-baseline gap-2 pt-2 justify-center lg:justify-start animate-fadeInUp" style="animation-delay:1s;"><span id="testimonyCounter" class="text-[#FFD53D] text-3xl md:text-4xl tabular-nums" style="text-shadow:0 0 30px rgba(255,213,61,.5)">0</span><span class="text-gray-400">t√©moignages enregistr√©s</span></div>
        </div>
        <div class="hidden lg:block relative"><div id="carouselContainer" class="grid grid-cols-2 gap-6 h-[700px] overflow-hidden"></div></div>
      </div>
    </div>
    <div onclick="scrollToWall()" class="absolute bottom-12 left-1/2 transform -translate-x-1/2 z-20 cursor-pointer animate-bounce">
      <svg class="w-8 h-8 text-white opacity-50 hover:opacity-80 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
    </div>
  </div>

  <div id="wall" class="py-20 px-6 bg-white">
    <div class="max-w-7xl mx-auto">
      <div class="mb-16">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
          <div class="text-center md:text-left">
            <h2 class="text-black mb-2">Mur en direct</h2>
            <p class="text-gray-600">Aper√ßu temps r√©el des actions de gr√¢ce publi√©es.</p>
          </div>
          <button onclick="openTestimonyForm()" class="bg-[#950000] hover:bg-[#750000] text-white rounded-full px-6 py-3 flex items-center gap-2 transition-all">Partager mon t√©moignage</button>
        </div>
        <div id="categoryFilters" class="flex flex-wrap gap-3 justify-center mb-12"></div>
      </div>
      <div id="testimonyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16"></div>
      <div id="pagination" class="flex items-center justify-center gap-6"></div>
    </div>
  </div>

  <!-- Minimal scripts: only the dynamic bits required -->
  <!-- Testimony Form Modal -->
  <div id="testimonyForm" class="fixed inset-0 z-50 hidden modal-backdrop">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-8 animate-scaleIn">
        <div class="flex justify-between items-start mb-6">
          <h2 class="text-black">Partager mon t√©moignage</h2>
          <button onclick="closeTestimonyForm()" class="text-gray-500 hover:text-black">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>
        <form onsubmit="submitTestimony(event)" class="space-y-6">
          <div>
            <label class="block text-gray-700 mb-2">Cat√©gorie</label>
            <select id="formCategory" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#950000]" required>
              <option value="Gu√©rison">Gu√©rison</option>
              <option value="Provision">Provision</option>
              <option value="Famille">Famille</option>
              <option value="D√©livrance">D√©livrance</option>
              <option value="√âducation">√âducation</option>
              <option value="Protection">Protection</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-700 mb-2">Titre (max 50 caract√®res)</label>
            <input type="text" id="formTitle" maxlength="50" placeholder="Ex: Gu√©rison miraculeuse" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#950000]" required />
          </div>
          <div>
            <label class="block text-gray-700 mb-2">Votre t√©moignage</label>
            <textarea id="formText" rows="6" placeholder="Racontez votre t√©moignage..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#950000]" required></textarea>
          </div>
          <div>
            <label class="block text-gray-700 mb-2">Couleur du post-it</label>
            <div class="flex gap-3">
              <label class="flex-1"><input type="radio" name="color" value="green" checked class="hidden peer" /><div class="w-full h-12 rounded-lg cursor-pointer border-2 border-transparent peer-checked:border-[#950000] transition-all" style="background-color:#E4FFEB"></div></label>
              <label class="flex-1"><input type="radio" name="color" value="yellow" class="hidden peer" /><div class="w-full h-12 rounded-lg cursor-pointer border-2 border-transparent peer-checked:border-[#950000] transition-all" style="background-color:#FFF6D9"></div></label>
              <label class="flex-1"><input type="radio" name="color" value="pink" class="hidden peer" /><div class="w-full h-12 rounded-lg cursor-pointer border-2 border-transparent peer-checked:border-[#950000] transition-all" style="background-color:#FFE5E5"></div></label>
            </div>
          </div>
          <button type="submit" class="w-full bg-[#950000] hover:bg-[#750000] text-white px-6 py-4 rounded-lg transition-colors">Publier mon t√©moignage</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer CTA -->
  <div class="relative py-24 px-6 bg-white overflow-hidden">
    <div class="absolute inset-0" style="background: radial-gradient(circle at 50% 50%, rgba(149, 0, 0, 0.05) 0%, rgba(255, 255, 255, 0) 70%);"></div>
    <div class="relative z-10 max-w-6xl mx-auto text-center">
      <div class="flex flex-wrap justify-center gap-4 mb-8">
        <div class="px-4 py-2 border-2 border-yellow-200 rounded-full text-gray-700">
          üèÜ <span id="statTestimonies">0</span> t√©moignages partag√©s
        </div>
        <div class="px-4 py-2 border-2 border-yellow-200 rounded-full text-gray-700">
          ‚ú® <span id="statAmens">0</span> Amens re√ßus
        </div>
        <div class="px-4 py-2 border-2 border-yellow-200 rounded-full text-gray-700">
          üíù <span id="statShares">0</span> partages
        </div>
      </div>

      <h2 class="text-black mb-6">Pr√™t √† t√©moigner ?</h2>
      <p class="text-gray-700 text-lg mb-12 max-w-2xl mx-auto">
        Votre histoire peut encourager, inspirer et fortifier la foi de milliers de personnes.
        Partagez ce que Dieu a fait dans votre vie.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        <div class="p-6 border border-gray-200 rounded-lg text-left hover:shadow-lg transition-shadow">
          <div class="w-12 h-12 rounded-full flex items-center justify-center bg-red-50 mb-4">
            <svg class="w-6 h-6 text-[#950000]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
          </div>
          <h3 class="text-black text-xl mb-2">√âcris ton t√©moignage</h3>
          <p class="text-gray-600 text-sm">Titre court (max 50 caract√®res) + description. Option photo (mod√©r√©e).</p>
        </div>
        <div class="p-6 border border-gray-200 rounded-lg text-left hover:shadow-lg transition-shadow">
          <div class="w-12 h-12 rounded-full flex items-center justify-center bg-red-50 mb-4">
            <svg class="w-6 h-6 text-[#950000]" fill="currentColor" viewBox="0 0 24 24"><path d="M16 12V4H8v8H2v10h20V12h-6zm-2 8h-4v-2h4v2zm0-4h-4v-2h4v2z"></path></svg>
          </div>
          <h3 class="text-black text-xl mb-2">√âpingle et c√©l√®bre</h3>
          <p class="text-gray-600 text-sm">Ton post-it appara√Æt sur le mur avec ta couleur. Animation douce √† l'ajout.</p>
        </div>
        <div class="p-6 border border-gray-200 rounded-lg text-left hover:shadow-lg transition-shadow">
          <div class="w-12 h-12 rounded-full flex items-center justify-center bg-red-50 mb-4">
            <svg class="w-6 h-6 text-[#950000]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
          </div>
          <h3 class="text-black text-xl mb-2">Partage & mod√®re</h3>
          <p class="text-gray-600 text-sm">Liens de partage, signalement, et validation par les mod√©rateurs CMP.</p>
        </div>
      </div>

      <button onclick="openTestimonyForm()" class="bg-[#950000] hover:bg-[#750000] text-white px-10 py-7 text-lg rounded-lg shadow-xl hover:shadow-2xl transition-all animate-pulse-soft">√âcrire mon t√©moignage</button>
    </div>

    <div class="relative z-10 mt-16 text-center text-gray-500 text-sm">
      <p>¬© 2025 Centre Missionnaire Philadelphie - Bunda21</p>
      <p class="mt-2">Tous les t√©moignages sont v√©rifi√©s avant publication</p>
    </div>
  </div>

  <script>
    const categories = ["Tous", "Vid√©os", "Gu√©rison", "Provision", "Famille", "D√©livrance", "√âducation", "Protection"];
    const colorMap = { yellow:'#FFF6D9', pink:'#FFE5E5', green:'#E4FFEB' };
    const fontMap = { 'Inter':'font-inter','Merriweather':'font-merriweather','Indie Flower':'font-indie-flower','Caveat':'font-caveat','Patrick Hand':'font-patrick-hand','Kalam':'font-kalam','Permanent Marker':'font-permanent-marker','Shadows Into Light':'font-shadows' };
    let currentUser = null;
    let isVerified = false;
    let selectedCategory = 'Tous';
    let currentPage = 1; const ITEMS_PER_PAGE = 9; let filteredTestimonies = [...testimonies];
    let currentModalIndex = 0;

    document.addEventListener('DOMContentLoaded', () => {
      checkAuth(); animateCounter(); calculateStats(); renderCategoryFilters(); filterTestimonies(); renderCarousel();
      // Ouvre la modale de connexion si ?signin=1
      const params = new URLSearchParams(window.location.search);
      if (params.get('signin') === '1') {
        openAuthDialog();
      }
    });
    function initAuth(){ const authBtn=document.getElementById('authButton'); authBtn.innerHTML = currentUser ? `<div class="relative"><button onclick="toggleUserMenu()" class="bg-white/10 backdrop-blur-sm border border-white/20 text-white hover:bg-white/20 px-4 py-2 rounded-lg flex items-center gap-2 transition-all"><div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#950000] to-[#750000] flex items-center justify-center"><span class="text-white text-sm">${currentUser.charAt(0).toUpperCase()}</span></div><span>${currentUser}</span></button><div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2"><div class="px-4 py-2 text-gray-500 text-sm border-b">${currentUser}</div><button onclick="signOut()" class="w-full text-left px-4 py-2 text-red-600 hover:bg-gray-50">Se d√©connecter</button></div></div>` : `<button onclick="openAuthDialog()" class="bg-white/10 backdrop-blur-sm border border-white/20 text-white hover:bg-white/20 px-4 py-2 rounded-lg flex items-center gap-2 transition-all">Sign In</button>`; }
    function toggleUserMenu(){ const m=document.getElementById('userMenu'); if(m) m.classList.toggle('hidden'); }
    function getCSRF(){ const name='csrftoken='; const parts=document.cookie.split(';'); for(let c of parts){ c=c.trim(); if(c.indexOf(name)===0) return c.substring(name.length,c.length);} return ''; }
    async function apiPost(url, data){
      const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCSRF()},credentials:'same-origin',body:JSON.stringify(data||{})});
      let json={};
      try{ json=await res.json(); }catch{ /* non-JSON */ }
      if(!res.ok || json.ok===false){
        const text = (!json || Object.keys(json).length===0) ? await res.text().catch(()=> '') : '';
        const msg = (json && json.error) ? json.error : (text || `Erreur API (HTTP ${res.status})`);
        throw new Error(msg);
      }
      return json;
    }
    async function checkAuth(){
      try{
        const r=await fetch('/auth/status/',{credentials:'same-origin'});
        const j=await r.json();
        isVerified = !!(j.ok && j.user);
        if(isVerified){
          currentUser=j.user.first_name?(j.user.first_name+(j.user.last_name?' '+j.user.last_name:'')):j.user.email;
          localStorage.setItem('bunda21_user', currentUser);
        } else {
          currentUser=null;
          localStorage.removeItem('bunda21_user');
        }
      }catch{ isVerified=false; currentUser=null; }
      initAuth();
    }
    function openAuthDialog(){
      let dlg=document.getElementById('authDialog');
      if(!dlg){
        // Build dialog if missing
        const wrapper=document.createElement('div');
        wrapper.innerHTML=`<div id="authDialog" class="fixed inset-0 z-50 modal-backdrop"><div class="flex items-center justify-center min-h-screen p-4"><div class="bg-white rounded-2xl max-w-md w-full p-8 animate-scaleIn"><h2 class="text-black mb-6 text-center">Connexion</h2><div id="authStep1"><div class="grid grid-cols-1 gap-3 mb-4"><input id="authFirstName" type="text" placeholder="Pr√©nom" class="w-full px-4 py-3 border border-gray-300 rounded-lg"><input id="authLastName" type="text" placeholder="Nom" class="w-full px-4 py-3 border border-gray-300 rounded-lg"><input id="authEmail" type="email" placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg"></div><div class="flex gap-3"><button onclick="closeAuthDialog()" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">Annuler</button><button onclick="startAuth()" class="flex-1 px-6 py-3 bg-[#950000] text-white rounded-lg hover:bg-[#750000]">Recevoir le code</button></div></div><div id="authStep2" class="hidden"><p class="text-gray-600 mb-4 text-center">Entrez le code re√ßu par email</p><input id="authCode" type="text" maxlength="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 tracking-widest text-center" placeholder="000000"><div class="flex gap-3"><button onclick="closeAuthDialog()" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">Annuler</button><button onclick="verifyAuth()" class="flex-1 px-6 py-3 bg-[#950000] text-white rounded-lg hover:bg-[#750000]">V√©rifier</button></div></div></div></div></div>`;
        document.body.appendChild(wrapper.firstChild);
      }
      document.getElementById('authDialog').classList.remove('hidden');
      document.getElementById('authStep1').classList.remove('hidden');
      document.getElementById('authStep2').classList.add('hidden');
    }
    function closeAuthDialog(){ const d=document.getElementById('authDialog'); if(d) d.remove(); }
    async function startAuth(){ const fn=document.getElementById('authFirstName').value.trim(); const ln=document.getElementById('authLastName').value.trim(); const em=document.getElementById('authEmail').value.trim(); if(!em){ showToast('Email requis'); return;} try{ await apiPost('/auth/start/',{first_name:fn,last_name:ln,email:em}); document.getElementById('authStep1').classList.add('hidden'); document.getElementById('authStep2').classList.remove('hidden'); showToast('Code envoy√© par email (console en dev)'); }catch(e){ showToast(e.message);} }
    async function verifyAuth(){ const em=document.getElementById('authEmail').value.trim(); const code=document.getElementById('authCode').value.trim(); if(!code){ showToast('Code requis'); return;} try{ await apiPost('/auth/verify/',{email:em,code}); closeAuthDialog(); await checkAuth(); showToast('Connect√© avec succ√®s'); }catch(e){ showToast(e.message);} }
    async function signOut(){ try{ await apiPost('/auth/logout/',{});}catch{} isVerified=false; currentUser=null; localStorage.removeItem('bunda21_user'); initAuth(); showToast('D√©connect√© avec succ√®s'); }
    function animateCounter(){ const counter=document.getElementById('testimonyCounter'); const target=testimonies.length; const duration=2000; const increment=target/(duration/16); let cur=0; const timer=setInterval(()=>{ cur+=increment; if(cur>=target){ counter.textContent=target; clearInterval(timer);} else { counter.textContent=Math.floor(cur);} },16); }
    function getAmensForTestimony(id){
      const seed = id * 7 + 23;
      return 10 + Math.floor((Math.sin(seed) * 0.5 + 0.5) * 50);
    }
    function calculateStats(){
      const totalAmens=testimonies.reduce((acc,t)=> acc + getAmensForTestimony(t.id),0);
      const totalShares=Math.floor(totalAmens*0.35);
      const st=document.getElementById('statTestimonies'); if(st) st.textContent=testimonies.length;
      const sa=document.getElementById('statAmens'); if(sa) sa.textContent=totalAmens.toLocaleString();
      const ss=document.getElementById('statShares'); if(ss) ss.textContent=totalShares;
    }
    function renderCarousel(){ const container=document.getElementById('carouselContainer'); if(!container) return; const ranked=[...testimonies].map(t=>({...t,amens:getAmensForTestimony(t.id)})).sort((a,b)=>b.amens-a.amens).slice(0,12); const col1=ranked.slice(0,6); const col2=ranked.slice(6,12); const renderColumn=(arr,cls)=>`<div class="relative h-full overflow-hidden rounded-2xl"><div class="absolute top-0 left-0 right-0 h-20 bg-gradient-to-b from-black to-transparent z-10 pointer-events-none"></div><div class="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-black to-transparent z-10 pointer-events-none"></div><div class="carousel-column ${cls} space-y-6">${[...arr,...arr,...arr].map(t=>createPostItHTML(t,false)).join('')}</div></div>`; container.innerHTML = `${renderColumn(col1,'carousel-column')}${renderColumn(col2,'carousel-column-2')}`; }
    function createPostItHTML(t,interactive=true){
      const rotation=(Math.random()-0.5)*6;
      const fontClass=fontMap[t.font]||'font-inter';
      const key=`amen_${t.id}`;
      const hasAmened = localStorage.getItem(key)==='true';
      const amens = getAmensForTestimony(t.id) + (hasAmened?1:0);
      const clickAttr = interactive ? ` onclick="openTestimony(${t.id})"` : '';
      if(t.type==='video'){
        return `
          <div class="postit-card group p-4 rounded-2xl relative shadow-md w-full" style="background-color:${colorMap[t.color]||'#E4FFEB'};transform:rotate(${rotation}deg);">
            <div class="absolute -top-2 left-1/2 transform -translate-x-1/2"><svg class="w-5 h-5 text-[#950000] fill-[#950000]" style="transform:rotate(45deg)" viewBox="0 0 24 24"><path d="M16 12V4H8v8H2v10h20V12h-6zm-2 8h-4v-2h4v2zm0-4h-4v-2h4v2z"></path></svg></div>
            <div class="mt-4 space-y-3 cursor-pointer"${clickAttr}>
              <div class="relative rounded-lg overflow-hidden">
                <img src="${t.thumbnail||''}" alt="${t.title}" class="w-full h-32 object-cover">
                <div class="absolute inset-0 bg-black/30 flex items-center justify-center group-hover:bg-black/50 transition-colors">
                  <div class="w-10 h-10 rounded-full bg-[#950000] flex items-center justify-center group-hover:scale-110 transition-transform">
                    <svg class="w-5 h-5 text-white fill-white ml-0.5" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                  </div>
                </div>
                <div class="absolute bottom-2 right-2 bg-black/80 px-2 py-1 rounded text-white text-xs">${t.duration||''}</div>
              </div>
              <h3 class="text-black leading-snug line-clamp-1">${t.title}</h3>
              <div class="flex items-center justify-between text-xs text-gray-500"><span class="truncate mr-2">${t.author}</span><span>${t.date||''}</span></div>
            </div>
            <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 mt-4 pt-4 border-t border-gray-300/50 flex items-center gap-2">
              <button onclick="handleAmen(event, ${t.id})" class="flex items-center gap-1.5 text-xs px-3 py-1.5 ${hasAmened?'bg-gray-400 cursor-not-allowed':'bg-[#950000] hover:bg-[#750000]'} text-white rounded"><span>üôå</span>Amen (${amens})</button>
            </div>
          </div>`;
      }
      return `
        <div class="postit-card group p-6 rounded-2xl relative shadow-md w-full ${fontClass}" style="background-color:${colorMap[t.color]||'#FFF6D9'};transform:rotate(${rotation}deg);">
          <div class="absolute -top-2 left-1/2 transform -translate-x-1/2"><svg class="w-5 h-5 text-[#950000] fill-[#950000]" style="transform:rotate(45deg)" viewBox="0 0 24 24"><path d="M16 12V4H8v8H2v10h20V12h-6zm-2 8h-4v-2h4v2zm0-4h-4v-2h4v2z"></path></svg></div>
          <div class="space-y-3 mt-4 cursor-pointer"${clickAttr}>
            <h3 class="text-black leading-snug line-clamp-2">${t.title}</h3>
            <p class="text-gray-700 text-sm leading-relaxed line-clamp-3">${t.text||''}</p>
          </div>
          <div class="flex items-center justify-between mt-6 text-xs text-gray-500"><span class="truncate mr-2">${t.author}</span><span>${t.date||''}</span></div>
          <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 mt-4 pt-4 border-t border-gray-300/50 flex items-center gap-2">
            <button onclick="handleAmen(event, ${t.id})" class="flex items-center gap-1.5 text-xs px-3 py-1.5 ${hasAmened?'bg-gray-400 cursor-not-allowed':'bg-[#950000] hover:bg-[#750000]'} text-white rounded"><span>üôå</span>Amen (${amens})</button>
          </div>
        </div>`;
    }
    function renderCategoryFilters(){ const c=document.getElementById('categoryFilters'); c.innerHTML = categories.map(cat=>`<button onclick="selectCategory('${cat}')" class="px-5 py-2 rounded-full text-sm transition-all ${selectedCategory===cat?'bg-[#950000] text-white shadow-lg scale-105':'bg-gray-100 text-gray-700 hover:bg-gray-200'}">${cat}</button>`).join(''); }
    function selectCategory(cat){ selectedCategory=cat; currentPage=1; renderCategoryFilters(); filterTestimonies(); }
    function filterTestimonies(){ if(selectedCategory==='Tous'){ filteredTestimonies=[...testimonies]; } else if(selectedCategory==='Vid√©os'){ filteredTestimonies=testimonies.filter(t=>t.type==='video'); } else { filteredTestimonies=testimonies.filter(t=> (t.category||'')===selectedCategory); } renderTestimonies(); renderPagination(); }
    function renderTestimonies(){ const el=document.getElementById('testimonyGrid'); const start=(currentPage-1)*ITEMS_PER_PAGE; const end=start+ITEMS_PER_PAGE; const cur=filteredTestimonies.slice(start,end); el.innerHTML = cur.map((t,idx)=> `<div class=\"animate-scaleIn\" style=\"animation-delay:${idx*0.1}s;\">${createPostItHTML(t,true)}</div>`).join(''); }
    function renderPagination(){ const el=document.getElementById('pagination'); const total=Math.ceil(filteredTestimonies.length/ITEMS_PER_PAGE); if(total<=1){ el.innerHTML=''; return;} const dots = Array.from({length:total},(_,i)=>`<button onclick="goToPage(${i+1})" class="h-2 rounded-full transition-all ${i+1===currentPage?'w-8 bg-[#950000]':'w-2 bg-gray-300 hover:bg-gray-400'}" aria-label="Page ${i+1}"></button>`).join(''); el.innerHTML = `<button onclick="goToPage(${currentPage-1})" ${currentPage===1?'disabled':''} class="flex items-center gap-2 text-gray-600 hover:text-black disabled:opacity-30 disabled:cursor-not-allowed transition-colors"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg><span class="text-sm">Pr√©c√©dent</span></button><div class="flex items-center gap-2">${dots}</div><button onclick="goToPage(${currentPage+1})" ${currentPage===total?'disabled':''} class="flex items-center gap-2 text-gray-600 hover:text-black disabled:opacity-30 disabled:cursor-not-allowed transition-colors"><span class="text-sm">Suivant</span><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>`; }
    function goToPage(p){ const total=Math.ceil(filteredTestimonies.length/ITEMS_PER_PAGE); if(p>=1&&p<=total){ currentPage=p; renderTestimonies(); renderPagination(); document.getElementById('wall').scrollIntoView({behavior:'smooth'});} }
    function scrollToWall(){ document.getElementById('wall').scrollIntoView({behavior:'smooth'}); }
    function openTestimonyForm(){
      if(!isVerified){ openAuthDialog(); return; }
      const m=document.getElementById('testimonyForm'); if(m) m.classList.remove('hidden');
    }
    function closeTestimonyForm(){ const m=document.getElementById('testimonyForm'); if(m) m.classList.add('hidden'); const t=document.getElementById('formTitle'); if(t) t.value=''; const tx=document.getElementById('formText'); if(tx) tx.value=''; }
    async function submitTestimony(e){
      e.preventDefault();
      // Gate by verification
      if(!isVerified){ openAuthDialog(); return; }

      const title = (document.getElementById('formTitle')?.value || '').trim();
      const text = (document.getElementById('formText')?.value || '').trim();
      const category = document.getElementById('formCategory')?.value || '';
      const color = (document.querySelector('input[name="color"]:checked')?.value) || 'yellow';

      if(!title || !text){
        showToast('Veuillez remplir le titre et le t√©moignage.');
        return;
      }

      try {
        // Get verified user info
        const r = await fetch('/auth/status/', { credentials: 'same-origin' });
        const j = await r.json().catch(()=>({}));
        if(!(j && j.ok && j.user)){
          openAuthDialog();
          return;
        }

        const user = j.user;
        const payload = {
          kind: 'text',
          first_name: user.first_name || '',
          last_name: user.last_name || '',
          email: user.email,
          title,
          text,
          category,
          postit_color: color,
          font_family: 'Inter',
          verification_type: 'email'
        };

        // Create testimony via API
        const created = await apiPost('/api/testimonies/', payload);

        // Optional: auto-approve in dev (ignore failures)
        try { if(created && created.id){ await apiPost(`/api/testimonies/${created.id}/approve/`, {}); } } catch {}

        // Close form
        closeTestimonyForm();

        // Push into local list and re-render
        const authorName = user.first_name ? `${user.first_name}${user.last_name ? ' ' + user.last_name : ''}` : (user.email || 'Utilisateur');
        const newItem = {
          id: created?.id || Date.now(),
          title,
          text,
          fullText: text,
          color: color,
          font: 'Inter',
          author: authorName,
          location: '',
          date: new Date().toLocaleDateString('fr-FR', { day:'numeric', month:'short' }),
          category
        };
        testimonies.unshift(newItem);
        filterTestimonies();
        calculateStats();

        showToast('T√©moignage publi√© ! Merci.');
      } catch (err) {
        showToast(err?.message || "Erreur lors de l‚Äôenvoi.");
      }
    }
    function showToast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),3000); }
    function handleAmen(event, testimonyId){ event?.stopPropagation?.(); const key=`amen_${testimonyId}`; if(localStorage.getItem(key)==='true') return; localStorage.setItem(key,'true'); try{ confetti && confetti({ particleCount: 40, spread: 60, origin: { y: 0.7 }, colors: ['#950000','#F5D693','#FFD6DC'] }); }catch{} renderTestimonies(); calculateStats(); }
    function openTestimony(id){ const t=testimonies.find(x=>x.id===id); if(!t) return; currentModalIndex = filteredTestimonies.findIndex(x=>x.id===id); const existing=document.getElementById('testimonyModal'); if(existing) existing.remove(); const wrapper=document.createElement('div'); const key=`amen_${t.id}`; const hasAmened=localStorage.getItem(key)==='true'; const amens=getAmensForTestimony(t.id)+(hasAmened?1:0); wrapper.innerHTML = `<div id=\"testimonyModal\" class=\"fixed inset-0 z-50 modal-backdrop\"><div class=\"flex items-center justify-center min-h-screen p-4\"><div class=\"bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-8 animate-scaleIn\"><div class=\"flex justify-between items-start mb-6\"><h3 id=\"modalTitle\" class=\"text-black\">${t.title}</h3><button id=\"modalCloseBtn\" class=\"text-gray-500 hover:text-black\"><svg class=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path></svg></button></div><div id=\"modalVideoContainer\" class=\"${t.type==='video'?'':'hidden'} mb-6\"><video id=\"modalVideo\" controls class=\"w-full rounded-lg\" ${t.type==='video'?`src=\"${t.videoUrl||''}\"`:''}></video></div><div id=\"modalContent\" class=\"text-gray-700 mb-6 whitespace-pre-line\">${(t.fullText||t.text||'')}</div><div class=\"flex items-center justify-between text-sm text-gray-500 mb-6 pb-6 border-b\"><span id=\"modalAuthor\">${t.author}${t.location?` - ${t.location}`:''}</span><span id=\"modalDate\">${t.date||''}</span></div><div class=\"flex items-center gap-3\"><button id=\"modalAmenBtn\" class=\"flex items-center gap-2 px-4 py-2 ${hasAmened?'bg-gray-400 cursor-not-allowed':'bg-[#950000] hover:bg-[#750000]'} text-white rounded-lg transition-colors\"><span>üôå</span><span id=\"modalAmenText\">Amen (${amens})</span></button><button id=\"shareTwitter\" class=\"p-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"><svg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z\"></path></svg></button><button id=\"shareWhatsApp\" class=\"p-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"><svg class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67 0.15-.197 0.297-.767 0.966-.94 1.164-.173 0.199-.347 0.223-.644 0.075-.297-0.15-1.255-0.463-2.39-1.475-0.883-0.788-1.48-1.761-1.653-2.059-0.173-0.297-0.018-0.458 0.13-0.606 0.134-0.133 0.298-0.347 0.446-0.52 0.149-0.174 0.198-0.298 0.298-0.497 0.099-0.198 0.05-0.371-0.025-0.52-0.075-0.149-0.669-1.612-0.916-2.207-0.242-0.579-0.487-0.5-0.669-0.51-0.173-0.008-0.371-0.01-0.57-0.01-0.198 0-0.52 0.074-0.792 0.372-0.272 0.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074 0.149 0.198 2.096 3.2 5.077 4.487 0.709 0.306 1.262 0.489 1.694 0.625 0.712 0.227 1.36 0.195 1.871 0.118 0.571-0.085 1.758-0.719 2.006-1.413 0.248-0.694 0.248-1.289 0.173-1.413-0.074-0.124-0.272-0.198-0.57-0.347m-5.421 7.403h-0.004a9.87 9.87 0 01-5.031-1.378l-0.361-0.214-3.741 0.982 0.998-3.648-0.235-0.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884\"/></svg></button><button id=\"shareCopy\" class=\"p-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors\"><svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z\"></path></svg></button></div><div class=\"flex justify-between mt-6 pt-6 border-t\"><button id=\"modalPrevBtn\" class=\"flex items-center gap-2 text-gray-600 hover:text-black transition-colors\"><svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 19l-7-7 7-7\"></path></svg>Pr√©c√©dent</button><button id=\"modalNextBtn\" class=\"flex items-center gap-2 text-gray-600 hover:text-black transition-colors\">Suivant<svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5l7 7-7 7\"></path></svg></button></div></div></div></div>`; document.body.appendChild(wrapper.firstChild); document.getElementById('modalCloseBtn').onclick=closeTestimonyModal; const amenBtn=document.getElementById('modalAmenBtn'); if(amenBtn && !hasAmened){ amenBtn.onclick = ()=> handleModalAmen(t.id); } document.getElementById('modalPrevBtn').onclick=()=>navigateTestimony(-1); document.getElementById('modalNextBtn').onclick=()=>navigateTestimony(1); document.getElementById('shareTwitter').onclick=()=>shareTestimony('twitter'); document.getElementById('shareWhatsApp').onclick=()=>shareTestimony('whatsapp'); document.getElementById('shareCopy').onclick=()=>shareTestimony('copy'); }
    function closeTestimonyModal(){ const m=document.getElementById('testimonyModal'); if(!m) return; const v=m.querySelector('#modalVideo'); try{ v && v.pause && v.pause(); }catch{} m.remove(); }
    function handleModalAmen(id){ const key=`amen_${id}`; if(localStorage.getItem(key)==='true') return; localStorage.setItem(key,'true'); try{ confetti && confetti({particleCount:100,spread:70,origin:{y:0.6},colors:['#950000','#F5D693','#FFD6DC']}); }catch{} const span=document.getElementById('modalAmenText'); if(span){ span.textContent = `Amen (${getAmensForTestimony(id)+1})`; } const btn=document.getElementById('modalAmenBtn'); if(btn){ btn.disabled=true; btn.classList.add('bg-gray-400','cursor-not-allowed'); btn.classList.remove('bg-[#950000]','hover:bg-[#750000]'); } renderTestimonies(); calculateStats(); }
    function navigateTestimony(dir){ const next=currentModalIndex+dir; if(next<0 || next>=filteredTestimonies.length) return; closeTestimonyModal(); setTimeout(()=> openTestimony(filteredTestimonies[next].id), 100); }
    function shareTestimony(platform){ const t=filteredTestimonies[currentModalIndex]; const text=`${t.title} - Mur de T√©moignages Bunda21`; const url=window.location.href; if(platform==='twitter'){ window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,'_blank'); } else if(platform==='whatsapp'){ window.open(`https://wa.me/?text=${encodeURIComponent(text+' '+url)}`,'_blank'); } else { navigator.clipboard.writeText(url).then(()=> showToast('Lien copi√© !')).catch(()=>{}); } }
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeTestimonyModal(); });
  </script>
</body>
</html>
